<div class="dashboard-wrapper">
  <!-- Dynamic Background Elements -->
  <div class="background-shapes">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
    <div class="glass-grid"></div>
  </div>

  <!-- Top Controls (Floating) -->
  <div class="top-controls">
    <button class="nav-item-btn admin-badge" *ngIf="isAdmin()" (click)="goToAdmin()">
      <i class="fas fa-shield-alt"></i> Admin
    </button>

    <div class="profile-dropdown-container">
      <button class="user-profile-badge" (click)="toggleProfileMenu()" [class.active]="showProfileMenu">
        <span class="user-name">{{ getFullName() }}</span>
        <div class="user-avatar-circle">
          {{ getFullName().charAt(0) }}
        </div>
      </button>

      <div class="dropdown-menu" *ngIf="showProfileMenu">
        <div class="menu-header">
          <span class="label">Signed in as</span>
          <span class="value">{{ currentUser.username || currentUser.voterId }}</span>
        </div>
        <div class="menu-divider"></div>
        <button class="menu-item" (click)="openChangePasswordModal()">
          <i class="fas fa-key"></i> Change Password
        </button>
        <button class="menu-item danger" (click)="signOut()">
          <i class="fas fa-sign-out-alt"></i> Sign Out
        </button>
      </div>
    </div>
  </div>

  <main class="main-content">

    <!-- Hero Banner -->
    <section class="hero-banner">
      <div class="banner-content">
        <div class="text-content">
          <span class="welcome-label">Welcome,</span>
          <h1 class="user-name-display">{{ getFullName() }}</h1>
          <p class="subtitle">Your secure dashboard for upcoming elections and voting history.</p>
        </div>
        <div class="banner-decoration">
          <div class="circle shape-1"></div>
          <div class="circle shape-2"></div>

          <!-- Vote Finger Animation -->
          <!-- Vote Polling Animation -->
          <div class="polling-animation">
            <div class="ballot-paper">
              <i class="fas fa-check"></i>
            </div>
            <div class="ballot-box">
              <div class="box-lid"></div>
              <div class="box-body">
                <i class="fas fa-vote-yea"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Stats / Info Row -->
    <section class="info-row">
      <div class="status-card">
        <div class="icon-box green">
          <i class="fas fa-id-card"></i>
        </div>
        <div class="info-text">
          <span class="label">Voter ID</span>
          <span class="value">{{ currentUser.voterId }}</span>
        </div>
      </div>

      <div class="status-card">
        <div class="icon-box blue">
          <i class="fas fa-envelope"></i>
        </div>
        <div class="info-text">
          <span class="label">Email</span>
          <span class="value">{{ currentUser.email }}</span>
        </div>
      </div>
    </section>

    <!-- Elections Content -->
    <section class="elections-section">
      <div class="section-toolbar">
        <div class="toolbar-left">
          <h3>Elections</h3>
          <span class="badge-count">{{ getFilteredElections().length }}</span>
        </div>

        <div class="toolbar-right">
          <button class="icon-button" (click)="refreshElections()" [disabled]="isLoading" title="Refresh">
            <i class="fas fa-sync-alt" [class.fa-spin]="isLoading"></i>
          </button>

          <div class="filter-group">
            <button class="filter-chip" [class.active]="selectedFilter === 'all'"
              (click)="onFilterChange('all')">All</button>
            <button class="filter-chip" [class.active]="selectedFilter === 'eligible'"
              (click)="onFilterChange('eligible')">
              <span class="dot green"></span> Eligible
            </button>
            <button class="filter-chip" [class.active]="selectedFilter === 'voted'" (click)="onFilterChange('voted')">
              <span class="dot blue"></span> Voted
            </button>
            <button class="filter-chip" [class.active]="selectedFilter === 'ended'"
              (click)="onFilterChange('ended')">Ended</button>
          </div>
        </div>
      </div>

      <!-- Grid -->
      <div class="elections-grid" *ngIf="!isLoading && getFilteredElections().length > 0">
        <app-election-card *ngFor="let election of getFilteredElections()" [election]="election"
          [hasVoted]="hasUserVoted(election.electionId)">
        </app-election-card>
      </div>

      <!-- Loading & Empty States -->
      <div class="state-container" *ngIf="isLoading">
        <div class="spinner"></div>
        <p>Loading elections...</p>
      </div>

      <div class="state-container empty" *ngIf="!isLoading && getFilteredElections().length === 0 && !errorMessage">
        <div class="empty-icon">
          <i class="fas fa-folder-open"></i>
        </div>
        <h4>No Elections Found</h4>
        <p>There are no elections matching your current filter.</p>
        <button class="btn-link" (click)="onFilterChange('all')">View All</button>
      </div>

      <div class="error-banner" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal-overlay" *ngIf="showChangePasswordModal" (click)="closeChangePasswordModal()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Change Password</h3>
        <button class="close-icon" (click)="closeChangePasswordModal()"><i class="fas fa-times"></i></button>
      </div>

      <form [formGroup]="changePasswordForm" (ngSubmit)="onChangePasswordSubmit()" class="modal-form">
        <div class="form-field">
          <label>New Password</label>
          <div class="input-with-icon">
            <input [type]="showNewPassword ? 'text' : 'password'" formControlName="newPassword"
              placeholder="Enter new password">
            <button type="button" class="eye-reveal" (click)="toggleNewPasswordVisibility()">
              <i class="fas" [class.fa-eye]="!showNewPassword" [class.fa-eye-slash]="showNewPassword"></i>
            </button>
          </div>

          <!-- Policy -->
          <div class="policy-list" *ngIf="changePasswordForm.get('newPassword')?.value">
            <div class="policy-item" *ngFor="let policy of getPasswordPolicyStatus()" [class.met]="policy.met">
              <i class="fas" [class.fa-check]="policy.met" [class.fa-circle]="!policy.met"></i>
              <span>{{ policy.requirement }}</span>
            </div>
          </div>
        </div>

        <div class="form-field">
          <label>Confirm Password</label>
          <div class="input-with-icon">
            <input [type]="showConfirmPassword ? 'text' : 'password'" formControlName="confirmPassword"
              placeholder="Confirm new password" [disabled]="!isNewPasswordValid()">
            <button type="button" class="eye-reveal" (click)="toggleConfirmPasswordVisibility()"
              [disabled]="!isNewPasswordValid()">
              <i class="fas" [class.fa-eye]="!showConfirmPassword" [class.fa-eye-slash]="showConfirmPassword"></i>
            </button>
          </div>
          <div class="field-error" *ngIf="getPasswordFieldError('confirmPassword')">
            {{ getPasswordFieldError('confirmPassword') }}
          </div>
        </div>

        <div class="form-message error" *ngIf="passwordChangeErrorMessage">{{ passwordChangeErrorMessage }}</div>
        <div class="form-message success" *ngIf="passwordChangeSuccessMessage">{{ passwordChangeSuccessMessage }}</div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" (click)="closeChangePasswordModal()">Cancel</button>
          <button type="submit" class="btn-primary" [disabled]="changePasswordForm.invalid || isChangingPassword">
            {{ isChangingPassword ? 'Updating...' : 'Update Password' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>