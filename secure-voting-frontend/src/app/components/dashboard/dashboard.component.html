<div class="dashboard-container">
  <header class="dashboard-header">
    <div class="header-content">
      <h1>Secure Voting Dashboard</h1>
      <div class="user-info">
        <span>Welcome, {{ getFullName() }}!</span>
        <!-- <button class="btn btn-outline" (click)="refreshElections()" [disabled]="isLoading" title="Refresh Elections">
          <i class="fas fa-sync-alt" [class.fa-spin]="isLoading"></i>
          {{ isLoading ? 'Refreshing...' : 'Refresh' }}
        </button>
        <button class="btn btn-success" (click)="goToVote()" style="margin-right: 10px;">
          <i class="fas fa-vote-yea"></i> Cast Vote
        </button>
        <button class="btn btn-warning" (click)="goToAdmin()" style="margin-left: 10px;">Test Admin (Always Visible)</button>
        <button class="btn btn-info" (click)="testNavigation()" style="margin-left: 10px;">Test Navigation</button> -->
        <button class="btn btn-primary" *ngIf="isAdmin()" (click)="goToAdmin()">Admin Panel</button>
        <div class="profile-dropdown-container">
          <button class="profile-icon-btn" (click)="toggleProfileMenu()" [class.active]="showProfileMenu">
            <i class="fas fa-user-circle"></i>
          </button>
          <div class="profile-dropdown" *ngIf="showProfileMenu">
            <button class="dropdown-item" (click)="openChangePasswordModal()">
              <i class="fas fa-key"></i>
              <span>Change Password</span>
            </button>
            <button class="dropdown-item" (click)="signOut()">
              <i class="fas fa-sign-out-alt"></i>
              <span>Log Out</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="dashboard-main">
    <div class="welcome-section">
      <h2>Welcome to Secure Voting System</h2>
      <p>You are successfully logged in. This is your secure voting dashboard.</p>
      
      <div class="user-details">
        <h3>Your Account Information</h3>
        <div class="info-grid">
          <div class="info-item">
            <label>Name:</label>
            <span>{{ getFullName() }}</span>
          </div>
          <div class="info-item" *ngIf="currentUser.voterId">
            <label>Voter ID:</label>
            <span>{{ currentUser.voterId }}</span>
          </div>
          <div class="info-item">
            <label>Email:</label>
            <span>{{ currentUser.email }}</span>
          </div>
          <!-- <div class="info-item">
            <label>Role:</label>
            <span>{{ currentUser.roles?.join(', ') || 'User' }}</span>
          </div> -->
        </div>
      </div>
    </div>

    <div class="elections-section">
      <div class="elections-header">
        <h3>All Elections</h3>
        <button class="btn btn-outline" (click)="refreshElections()" [disabled]="isLoading" title="Refresh Elections">
          <i class="fas fa-sync-alt" [class.fa-spin]="isLoading"></i>
          Refresh
        </button>

        <!-- <button class="btn btn-outline" (click)="loadUsers()" [disabled]="isLoading" title="Refresh Users">
            <i class="fas fa-sync-alt" [class.fa-spin]="isLoading"></i>
            Refresh
          </button> -->
      </div>

      <!-- Filter Tabs -->
      <div class="election-filters">
        <button 
          class="filter-btn" 
          [class.active]="selectedFilter === 'all'"
          (click)="onFilterChange('all')"
        >
          All Elections ({{ getFilterCount('all') }})
        </button>
        <button 
          class="filter-btn eligible" 
          [class.active]="selectedFilter === 'eligible'"
          (click)="onFilterChange('eligible')"
        >
          Eligible ({{ getFilterCount('eligible') }})
        </button>
        <button 
          class="filter-btn voted" 
          [class.active]="selectedFilter === 'voted'"
          (click)="onFilterChange('voted')"
        >
          Voted ({{ getFilterCount('voted') }})
        </button>
        <button 
          class="filter-btn pending" 
          [class.active]="selectedFilter === 'pending'"
          (click)="onFilterChange('pending')"
        >
          Pending ({{ getFilterCount('pending') }})
        </button>
        <button 
          class="filter-btn ended" 
          [class.active]="selectedFilter === 'ended'"
          (click)="onFilterChange('ended')"
        >
          Ended ({{ getFilterCount('ended') }})
        </button>
      </div>

      <div class="error-message" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>

      <div class="elections-grid" *ngIf="!isLoading && getFilteredElections().length > 0">
        <app-election-card 
          *ngFor="let election of getFilteredElections()"
          [election]="election"
          [hasVoted]="hasUserVoted(election.electionId)"
        ></app-election-card>
      </div>

      <div class="no-elections" *ngIf="!isLoading && getFilteredElections().length === 0 && !errorMessage">
        <div class="no-elections-content">
          <h4>No Elections Found</h4>
          <p *ngIf="selectedFilter === 'all'">There are no elections available at this time.</p>
          <p *ngIf="selectedFilter === 'eligible'">There are currently no eligible elections for you to vote in.</p>
          <p *ngIf="selectedFilter === 'voted'">You haven't voted in any elections yet.</p>
          <p *ngIf="selectedFilter === 'pending'">There are no pending elections at this time.</p>
          <p *ngIf="selectedFilter === 'ended'">There are no ended elections to display.</p>
          <p>Check back later or contact your administrator for more information.</p>
        </div>
      </div>

      <div class="loading-elections" *ngIf="isLoading">
        <div class="loading-content">
          <div class="spinner-large"></div>
          <p>Loading elections...</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Change Password Modal -->
  <div class="modal-overlay" *ngIf="showChangePasswordModal" (click)="closeChangePasswordModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Change Password</h3>
        <button class="modal-close" (click)="closeChangePasswordModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form [formGroup]="changePasswordForm" (ngSubmit)="onChangePasswordSubmit()" class="change-password-form">
        <div class="form-group">
          <label for="newPassword">New Password *</label>
          <div class="password-input-wrapper">
            <input
              [type]="showNewPassword ? 'text' : 'password'"
              id="newPassword"
              formControlName="newPassword"
              class="form-control"
              [class.error]="getPasswordFieldError('newPassword')"
              placeholder="Enter your new password"
            />
            <button type="button" class="password-toggle-btn" (click)="toggleNewPasswordVisibility()">
              <i class="fas" [class.fa-eye]="!showNewPassword" [class.fa-eye-slash]="showNewPassword"></i>
            </button>
          </div>
          <div class="password-policy" *ngIf="changePasswordForm.get('newPassword')?.value">
            <div class="policy-requirement" *ngFor="let policy of getPasswordPolicyStatus()">
              <i class="fas" [class.fa-check-circle]="policy.met" [class.fa-times-circle]="!policy.met" 
                 [class.requirement-met]="policy.met" [class.requirement-unmet]="!policy.met"></i>
              <span [class.requirement-met]="policy.met" [class.requirement-unmet]="!policy.met">
                {{ policy.requirement }}
              </span>
            </div>
          </div>          
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirm Password *</label>
          <div class="password-input-wrapper">
            <input
              [type]="showConfirmPassword ? 'text' : 'password'"
              id="confirmPassword"
              formControlName="confirmPassword"
              class="form-control"
              [class.error]="getPasswordFieldError('confirmPassword')"
              placeholder="Confirm your new password"
              [disabled]="!isNewPasswordValid()"
            />
            <button type="button" class="password-toggle-btn" (click)="toggleConfirmPasswordVisibility()" [disabled]="!isNewPasswordValid()">
              <i class="fas" [class.fa-eye]="!showConfirmPassword" [class.fa-eye-slash]="showConfirmPassword"></i>
            </button>
          </div>
          <div class="error-message" *ngIf="getPasswordFieldError('confirmPassword') && (changePasswordForm.get('confirmPassword')?.touched || changePasswordForm.get('confirmPassword')?.dirty)">
            {{ getPasswordFieldError('confirmPassword') }}
          </div>
        </div>

        <div class="error-message" *ngIf="passwordChangeErrorMessage">
          {{ passwordChangeErrorMessage }}
        </div>

        <div class="success-message" *ngIf="passwordChangeSuccessMessage">
          <i class="fas fa-check-circle"></i>
          {{ passwordChangeSuccessMessage }}
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeChangePasswordModal()" [disabled]="isChangingPassword">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="isChangingPassword || changePasswordForm.invalid">
            <span *ngIf="isChangingPassword" class="spinner"></span>
            {{ isChangingPassword ? 'Changing...' : 'Change Password' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
